{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/til/spring-boot-crud-refactoring/","result":{"data":{"site":{"siteMetadata":{"title":"조성개발실록"}},"markdownRemark":{"id":"f9f5f212-bb39-5813-a465-10b5f989092b","excerpt":"! 주의 : TIL 게시글입니다. 다듬지 않고 올리거나 기록을 통째로 복붙했을 수 있는 뒷고기 포스팅입니다. 저번에 한거 PR올려서 피드백을 받았는데 고칠게 한참이나 있었습니다. 피드백 반영하기 위한 수정사항이 있었고 그 기록입니다 소유주 확인 유저가 page…","html":"<blockquote>\n<p>! 주의 : TIL 게시글입니다. 다듬지 않고 올리거나 기록을 통째로 복붙했을 수 있는 뒷고기 포스팅입니다.</p>\n</blockquote>\n<p><a href=\"https://sungpaks.github.io/til/spring-boot-crud-and-trying-hexagonal-architecture/\">저번에 한거</a> PR올려서 피드백을 받았는데<br>\n고칠게 한참이나 있었습니다.<br>\n피드백 반영하기 위한 수정사항이 있었고 그 기록입니다</p>\n<h1 id=\"소유주-확인\" style=\"position:relative;\"><a href=\"#%EC%86%8C%EC%9C%A0%EC%A3%BC-%ED%99%95%EC%9D%B8\" aria-label=\"소유주 확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>소유주 확인</h1>\n<p>유저가 page같은 어떤 정보를 요청할 때<br>\n다른 유저의 정보까지 접근 가능하면 안 되겠죠?<br>\n응당 본인의 정보만 접근이 가능해야 하겠습니다<br>\n관리자 권한이 있는 경우를 제외하면요.</p>\n<p>그래서.. 일부 api 요청에 대해 <em>\"소유주가 맞는지?\"</em> 체크를 하기로 하여<br>\n<em>\"요청 들어오면 토큰 뜯어서 유저 정보 확인할까요?\"</em> 라고 질문했는데..</p>\n<p>갈!!!!!! 토큰을 왜 뜯냐??<br>\n<code class=\"language-text\">@AuthenticationPrincipal</code>로 바로 확인해버릴 수 있는데!!<br>\n<a href=\"https://docs.spring.io/spring-security/reference/servlet/integrations/mvc.html\">https://docs.spring.io/spring-security/reference/servlet/integrations/mvc.html</a><br>\n<a href=\"https://wildeveloperetrain.tistory.com/324\">https://wildeveloperetrain.tistory.com/324</a><br>\n이런거 참고해서 해봐라!!</p>\n<p>라고 꾸짖음 당했습니다.</p>\n<p>자세히 알아보니.. SpringSecurity에서 제공하는 기능을 사용하면<br>\nController의 인자에서 <code class=\"language-text\">@AuthenticationPrincipal</code> 어노테이션으로 인증 정보를 가져올 수 있었습니다<br>\n이 <code class=\"language-text\">principal</code>값은 유저를 구분하는 고유값이고 제가 진행중인 프로젝트에서는 <code class=\"language-text\">userId</code>(고유한 문자열)을 넣고 있었으므로<br>\n그냥.. Controller에서 인자로 <code class=\"language-text\">@AuthenticationPrincipal userId</code> 이렇게 가져오기만 하면 되는 일이었습니다</p>\n<p>이제 <code class=\"language-text\">(현재 인증 정보) === (요청하려는 정보의 소유주)</code> 를 확인하고,<br>\n일치하지 않으면 에러를 던지면 되겠어요\n근데 자바 코드인데 <code class=\"language-text\">===</code>로 확인했네요? ㅋㅋㅋ 진짜로 자주 저러고 있습니다. 습관적으로..</p>\n<h2 id=\"이런-검증은-어디서-하면-좋나요\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EB%9F%B0-%EA%B2%80%EC%A6%9D%EC%9D%80-%EC%96%B4%EB%94%94%EC%84%9C-%ED%95%98%EB%A9%B4-%EC%A2%8B%EB%82%98%EC%9A%94\" aria-label=\"이런 검증은 어디서 하면 좋나요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이런 검증은 어디서 하면 좋나요?</h2>\n<p><code class=\"language-text\">userId</code>가 소유주에 해당하는게 맞는지..<br>\n이런 검증들은 어디서 하는게 좋을까요??<br>\nController? Service? ..? 이에 대해 전문가 팀원과 이야기해봤는데요..(사실상 듣는 쪽이었음)<br>\n<a href=\"https://kukim.tistory.com/76\">계약에 의한 설계</a>와 단일 책임 원칙을 생각해본다면<br>\n<strong>Controller</strong>가 적당하다고 생각됩니다<br>\nService의 일은, 비즈니스 로직을 수행하는 책임 하나만 지고, 값에 대한 의심은 하지 않게 합니다<br>\nController의 일은, 적절한 서비스를 호출하는 책임을 지고, 부적절한 요청 검증은 이 선에서 처리하는게 좋겠어요<br>\n이런 원칙을 두어야.. 제가 제 코드를 믿지 못하고 Controller에서도 검증, Service에서도 검증, ... 이러는 상황이 벌어지지 않겠습니다</p>\n<h1 id=\"charset-설정\" style=\"position:relative;\"><a href=\"#charset-%EC%84%A4%EC%A0%95\" aria-label=\"charset 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CHARSET 설정</h1>\n<p>전에 다른 프로젝트 할 때도 당했던건데<br>\n윈도우만 그런지?는 모르겠지만?(다른 팀원들은 맥쓰는데 관련 트러블이 없었다는 것 같아요)<br>\nMySQL에 한글 넣으려면 따로 CHARSET을 설정해줘야 합니다<br>\n안그러면 <code class=\"language-text\">Data truncation: Incorrect string value</code> 이렇게 생긴 에러가 발생합니다</p>\n<p>이건 직접 MySQL 들어가서<br>\n<code class=\"language-text\">ALTER TABLE 테이블 convert to charset UTF8;</code> 이런 식으로 해줄 수도 있고</p>\n<p>스프링 단에서 할 수는 없나? 싶어서 찾아보고 <a href=\"https://yeonyeon.tistory.com/167\">여기</a>를 참고한 결과,\n엔티티 전체에 적용은 못한다고 하네요? 가능한 방법을 알고계시다면 알려주세요.<br>\n<code class=\"language-text\">@Column(columnDefinition = \"VARCHAR(100) CHARACTER SET UTF8\")</code> 이렇게 어노테이션에 속성을 추가해서 컬럼단위로는 설정해줄 수 있습니다</p>\n<h1 id=\"엔티티-연관관계-매핑\" style=\"position:relative;\"><a href=\"#%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84-%EB%A7%A4%ED%95%91\" aria-label=\"엔티티 연관관계 매핑 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>엔티티 연관관계 매핑</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 295px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/379cfb4c95660df98857d14d1bb3e8bc/e4a3f/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADP0lEQVR42o1UWXMSQRDeN32yPEJgYQl738tym13CQgCTkLAsCQaIwRKjlvr/f8Bnz5jDlEf58FXPTB/TM193C4PBALPZDK7rIl8ooCRJKJZKj1Es/n5GYLa7+TzCsIarq2u0220IlmmjFjagKjKKIgUsilw+QERZKv3h/AHMt+p70DUNwtv+C6yTp0i7NaT7FiLlGQ7dPAbOLvp2DolXwvf1Gdd1jZfoGLvYN3I/oeewHHfwbTXBkHx8OQ8hrsnot2Qk7RCLySGODppo2BW0PRVNR0HL07DOjrmubiuomnuoWxWOkJAd9bFZTHHa78BSyxB0w4ZmOGi22sjm5xiN3yCo1uAHVbieD8fzMDmb4mya8r1umDAtGwaDaXH7NJtjOBpDVlQItm3DISS9BMvlJTbX19hsNvTJa2RZhrBaxcV8ju32A/pJAlVVwXwsy+KYTs/I9gqTkxMoikIZ6joYeGDH4WCGTLIz3TDgU/au68GkNbM1SBq3a9M0eYV49BKNkXJ3EwNTMvA1AznZZNwYHfG9dav7E5gfS4A/+a9gmdLNYdylvYV/2t7ivwJWo5iv/zvg3d/9BtK5foBOOieGPTp7sP1rQPZ+xtwdOY9An2yQUeftisrE4vs7Un4l8FFAVkefPn9Bvd7Ay1c7KIhF6mkRudwu9WmBr/MkCyRF0u3s5Kj+TGxvbnB+foEoiqgSdDhEnk0XCLosoVVz4dsmDKUMRSpAKRfhO8S4uodKqYA9SeSSQS6LcE0NAekN8tUqZRiUtUVZMwibw+fYDp4gPahjHjuIqZcTR8TXy2Oshw3sa68QWQXEZh4x9fHA38OXixE+X4wxpF5vuxU0h0eodXsID3oQWocNRG8aOK6r2M4SfJz1MaopuD6JcUPrvifhNQ0BFjCigZC4JWwmMQcL2DQlONSqXhDAJQh+r4NgGOH4dYD32RinlGnkK1idJng/H2Pfk9EwRLStIlokY1/Fu3SId7MRkqCCQJeIKIPXKSNIsNn7ieWDXg+XyxUNhipMYitNZ1gsFpxJ1n6sU9hgYMM0o2GwXK3QJR+ZfH9lWmDGjDXWh5qm3veoIldgkbMdhj/L575/NV5m2v2Z/ijgD0oKQ1IYtjtOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"연관관계\"\n        title=\"\"\n        src=\"/static/379cfb4c95660df98857d14d1bb3e8bc/e4a3f/image.png\"\n        srcset=\"/static/379cfb4c95660df98857d14d1bb3e8bc/c26ae/image.png 158w,\n/static/379cfb4c95660df98857d14d1bb3e8bc/e4a3f/image.png 295w\"\n        sizes=\"(max-width: 295px) 100vw, 295px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>대충 이런 관계가 있다고 해봅시다\n처음에는 그냥, <code class=\"language-text\">Page</code>의 <code class=\"language-text\">userId</code>가 <code class=\"language-text\">User</code>의 <code class=\"language-text\">id</code>이게끔 관계만 두고,<br>\n<em>특정 유저의 페이지들을 조회</em> 하는 등의 상황에서는<br>\nFK를 걸든, 쪼인을 하든, 한다는 순전히 DB관점에서 생각했습니다</p>\n<p>근데 JPA로 테이블을 엔티티로 영속화하여 사용하므로 그러한 관점에서 매핑해야겠어요<br>\n이를 위해 일단 기존에 <code class=\"language-text\">String userId;</code>(ERD에서는 <code class=\"language-text\">Long</code>인데 실제로 <code class=\"language-text\">String</code>으로 사용중)로 했었다면<br>\n<code class=\"language-text\">User user</code> 이렇게 하고 <code class=\"language-text\">@ManyToOne, @OneToMany, ...</code> 같은 어노테이션을 붙여서<br>\n다대일, 일대다, 등 엔티티간의 연관관계를 매핑해줍니다.</p>\n<p>이 때, <strong>연관관계의 주인</strong>개념이 존재하는데,<br>\n이는 즉 매핑을 거는 쪽이 주체가 된다는. 거십니다</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 395px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/55cd5b36d629cb59bd5b771eae8cde4c/2cb6c/image-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.41772151898735%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcElEQVR42o2S626CQBCFef+38ocxhhAgMRCMAbxxUUEEvAQV+pmhlLTFdhM2s8OcM3POrlLXddM07EVRJElyv9+bgSWV/VjhO51Oy+XSNM3tdnu5XIbAlFmWtV6vd7vd8/l8gcMw9H3fdd3NZgPFz87S5Hw+z2azsiw5UgbFC+w4DgB6ks2ybL/fkxXiPjiKouPx2B3n83lVVYphGLqug6c/FAzWVdSfi5hWwitHaakEQTCdTrHqcDjI8LCghTlFglTfbjdMQfbj8QDZjs0BmKZpq9WKmBTzMCG/YSGZpikuQgEXw9u2Lcpbt6meTCZk6YwZ3ZXABSyOY5Ke50G0WCxGoxGVsLTg6/WKVPED+r7gzjbycFHJ8MTtVcmP8XiMbTT59ao62QhRVZUd816GkUUD9hAgDwlDjwRTxXD6SxvlG/2bJQW4202n9JHv8fKXW2T+L/B/GuZ5zhNgWsA8RCSw/w2WhU4c4ZGw4xFBWZYfYrRdhWe/iCEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"매핑\"\n        title=\"\"\n        src=\"/static/55cd5b36d629cb59bd5b771eae8cde4c/2cb6c/image-1.png\"\n        srcset=\"/static/55cd5b36d629cb59bd5b771eae8cde4c/c26ae/image-1.png 158w,\n/static/55cd5b36d629cb59bd5b771eae8cde4c/6bdcf/image-1.png 315w,\n/static/55cd5b36d629cb59bd5b771eae8cde4c/2cb6c/image-1.png 395w\"\n        sizes=\"(max-width: 395px) 100vw, 395px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>대충 그림으로는 이런식ㅋㅋㅋ으로 실제 손을 뻗어서 잡은 쪽이 연관관계의 주인이라는 뜻인데<br>\nDB입장에서 보면 FK를 가지는 쪽이 되겠죠?</p>\n<p>이 <strong>연관관계의 주인은 자식 테이블(엔티티)가 되게 매핑하는게 좋다</strong>(1-M에서, M쪽)고 하는데<br>\nDB관점에서 생각해보면, 보통 테이블 간에 FK를 걸 때 자식 테이블이 FK를 가지므로<br>\n엔티티 간에 매핑을 할 때도 자식 테이블에서 매핑을 걸어주는게 합리적이고, 패러다임이 일치하겠죠?<br>\n이렇게 해서, 부모 엔티티에서는 자식 엔티티에 대해서는 하등 몰라도 되게끔 하면 좋겠습니다</p>\n<p>그런데 부모 엔티티에 매핑된 자식 엔티티들을 자주 참조해야할 수도 있어요<br>\n위 예시를 또 들어보면, <em>특정 유저의 모든 페이지 조회</em> 이런 것들이 있겠죠?<br>\n이런 경우, <code class=\"language-text\">@OneToMany</code> 어노테이션에 <code class=\"language-text\">mappedBy</code> 속성을 넣어서 <strong>읽기 전용</strong>으로 참조해줍시다<br>\n이렇게 읽기 전용으로 해주지 않으면, 연관관계가 양쪽 다 걸려버리니<br>\n부모가 수정될 떄마다 자식도 수정되는 드러운 사태가 벌어지고 맙니다..</p>\n<p>앗, 그리고 다대다 매핑(<code class=\"language-text\">@ManyToMany</code>)을 할 일이 생긴다면, <strong>중간 테이블</strong>을 만들어서<br>\n<code class=\"language-text\">@ManyToOne - @OneToMany</code>로 풀어내는게 좋겠다고 합니다<br>\n더 자세한 내용은 저는 <a href=\"https://colevelup.tistory.com/41\">여기..</a>를 참고했어욥</p>\n<p>그리고 연관관계의 <code class=\"language-text\">FetchType</code>을 <code class=\"language-text\">LAZY</code>로 설정하니<br>\n<code class=\"language-text\">No serializer found for class .....</code> 어쩌구 에러가 떴는데<br>\nREST API니까 JSON으로 반환하고자 직렬화하려는데?<br>\n앗! <code class=\"language-text\">LAZY</code>로 인해 프록시객체가 들어차있는 바람에..<br>\n이 엔티티를 직접 반환하지 못하는 상황이 벌어진 거십니다<br>\n그래서 DTO를 만들고, 여기에 필요한 것만 뽑아 감싸서 반환하게 했습니다~</p>\n<h1 id=\"매핑하니까-n1문제가-\" style=\"position:relative;\"><a href=\"#%EB%A7%A4%ED%95%91%ED%95%98%EB%8B%88%EA%B9%8C-n1%EB%AC%B8%EC%A0%9C%EA%B0%80-\" aria-label=\"매핑하니까 n1문제가  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>매핑하니까 N+1문제가 .</h1>\n<p>N+1문제란..<br>\n제가 만약 <em>모든 Page 엔티티를 조회</em> 한다고 해봅시다<br>\n저는 <code class=\"language-text\">select * from pages</code>처럼 1회 쿼리로 끝나겠지? 라고 생각하지만<br>\n현실은.. Page 엔티티에 연관관계가 등록된 User까지 가져오려고 시도하여<br>\n각각의 Page 엔티티 하나마다 \"그 Page를 쓴 유저\"를 가져오는 쿼리까지 발생해버립니다!</p>\n<p>그럼 Page 엔티티를 10개 가져왔다면, (Page 모두 가져오기 1회) + (각 Page에 연관된 User 가져오기 1회) * 10 = 11회의 쿼리가 발생합니다 ㄷㄷ<br>\nN개 엔티티를 가져오는 상황에서, 기대한 1회 쿼리가 아닌 N+1회의 쿼리가 발생한다고 하여 저런 이름이 붙었습니다</p>\n<p>앞서 <code class=\"language-text\">FetchType</code>을 알아보고 가자면<br>\n연관관계 매핑된 엔티티들을 <code class=\"language-text\">EAGER</code>로 즉시로딩할 수 있고, 또는 <code class=\"language-text\">LAZY</code>로 지연로딩할 수 있습니다.<br>\n<code class=\"language-text\">EAGER</code>는 호출 타이밍에 객체를 전부 가져오고<br>\n<code class=\"language-text\">LAZY</code>는 실제 참조하기 전까지는 프록시 객체를 가짜로 집어넣어둡니다<br>\n이걸 <code class=\"language-text\">LAZY</code>로 설정하면 N+1문제가 발생하던 것이 1회의 쿼리만 발생하는 듯 보이지만<br>\nN에 해당하는 연관 엔티티들을 참조할 때마다 새로운 쿼리가 발생되므로<br>\n쿼리의 발생 시점이 다를 뿐이지 N+1문제가 해결되지 않습니다 ㅜㅜ<br>\n딸깍으로 꿀빨기는 실패했어요</p>\n<p>근데 <code class=\"language-text\">LAZY</code>로 일단 해두면 좋은게<br>\n제가 만약 Page 엔티티만 조회하고 싶어요.. 연관된 User는 궁금하지도 않고.<br>\n<code class=\"language-text\">EAGER</code>였다면 궁금하지 않았던 User까지 다 가져오겠지만<br>\n<code class=\"language-text\">LAZY</code>와 함께하고, DTO같은 객체에 필요한 것만 담아서 사용하면?<br>\n궁금하지도 않았던 User 엔티티를 조회하는 쿼리가 발생할 일이 없습니다! 굿</p>\n<p>그래서 N+1프라브람.. 해결하는 방법이 뭐냐 하면<br>\n(1) JPQL로 직접 메서드를 작성하고, fetch join을 사용 : INNER JOIN 유발<br>\n(2) Entity Graph : <code class=\"language-text\">@EntityGraph(attributePath)</code> 어노테이션으로 엔티티 그래프를 지정하고, JPQL작성 : EAGER조회, OUTER JOIN 유발<br>\n(3) Batch Size 설정<br>\n(4) <code class=\"language-text\">@Fetch(FetcMode.SUBSELECT)</code>로 서브쿼리처럼 할 수 있다<br>\n(5) Querydsl같은 쿼리빌더같은거로 손수 작성..<br>\n등등.. 많은 방법이 있어보였는데<br>\n저는 1번 fetch join으로 해보기로 했습니다</p>\n<p>기존에 Page 엔티티에서 <code class=\"language-text\">findAll()</code>을 사용해버리면 User 연관관계를 개별 쿼리로 가져온다는 점이 문제였던 것이니까<br>\n<em>PageRepository.java</em>에서 fetch join 버전 <code class=\"language-text\">findAll()</code>을 작성하기로 했습니다</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select p from Page p join fetch p.user\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Page</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllJoinFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이런 식으로 하면 되겠죠?<br>\nJPQL은 SQL과 사알짝 다르지만 굉장히 유사하네요</p>\n<hr>\n<p>기록 끝~</p>","frontmatter":{"title":"Spring Boot CRUD TIL 기록 (2)","date":"August 22, 2024","description":"PR 후 피드백 반영하여 수정하기.","tag":["TIL","Java","Spring"]},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%86%8C%EC%9C%A0%EC%A3%BC-%ED%99%95%EC%9D%B8\">소유주 확인</a></p>\n<ul>\n<li><a href=\"#%EC%9D%B4%EB%9F%B0-%EA%B2%80%EC%A6%9D%EC%9D%80-%EC%96%B4%EB%94%94%EC%84%9C-%ED%95%98%EB%A9%B4-%EC%A2%8B%EB%82%98%EC%9A%94\">이런 검증은 어디서 하면 좋나요?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#charset-%EC%84%A4%EC%A0%95\">CHARSET 설정</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84-%EB%A7%A4%ED%95%91\">엔티티 연관관계 매핑</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A7%A4%ED%95%91%ED%95%98%EB%8B%88%EA%B9%8C-n1%EB%AC%B8%EC%A0%9C%EA%B0%80-\">매핑하니까 N+1문제가 .</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/contributing-nodejs/"},"frontmatter":{"title":"🐢 Node.js에 기여한 썰 푼다."}},"next":null},"pageContext":{"id":"f9f5f212-bb39-5813-a465-10b5f989092b","previousPostId":"a8cb61cd-98f9-53a3-8e94-c37cb2715563","nextPostId":null}},"staticQueryHashes":["2841359383"],"slicesMap":{}}